"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var JS=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"isString",value:function(e){return"string"==typeof e}},{key:"padNumber",value:function(t,n){if(t<0)return"-"+e.padNumber(-t,n-1);for(var i=t%10,s=Math.floor(t/10),r=""+i,o=1;o<n;o++)0===s?r="0"+r:(i=s%10,s=Math.floor(s/10),r=""+i+r);return r}},{key:"lessProps",value:function(e,t){var n=Object.assign({},e);if(!t)return n;return[].concat(t).forEach(function(t){if("string"==typeof t){var i=new RegExp("^"+t+"$");Object.keys(e).map(function(e){e.match(i)&&delete n[e]})}}),n}},{key:"hasProps",value:function(e,t){if(!t)return 0;var n=0;return[].concat(t).forEach(function(t){if("string"==typeof t){var i=new RegExp("^"+t+"$");Object.keys(e).map(function(e){e.match(i)&&n++})}}),n}},{key:"traverseProps",value:function(t,n){n?e._traverseProps([],t,n):console.log("no callback for traverse, do nothing")}},{key:"_traverseProps",value:function(t,n,i){"object"===(void 0===n?"undefined":babelHelpers.typeof(n))&&Object.keys(n).forEach(function(s){var r=n[s];i(t,s,r),e._traverseProps(t.concat(s),r,i)})}},{key:"isArray",value:function(e){return"object"===(void 0===e?"undefined":babelHelpers.typeof(e))&&"number"==typeof e.length}},{key:"sureArray",value:function(e){return[].concat(e)}},{key:"appendUnique",value:function(e,t){if(!e)return!1;return!(e.filter(function(e){return e===t}).length>0)&&(e.push(t),!0)}},{key:"ts",value:function(){return(new Date).getTime()}},{key:"isUndefined",value:function(e){return void 0===e}},{key:"undefinedThen",value:function(t,n){return e.isUndefined(t)?n:t}}]),e}(),LOG_LEVELS={VERBOSE:1,DEBUG:2,INFO:3,WARN:4,ERROR:5},ConsoleLogger=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"WARN";babelHelpers.classCallCheck(this,e),this.name=t,this.level=n}return babelHelpers.createClass(e,[{key:"_ts",value:function(){var e=new Date;return[JS.padNumber(e.getMinutes(),2),JS.padNumber(e.getSeconds(),2)].join(":")+"."+e.getMilliseconds()}},{key:"_key",value:function(e,t){var n=["["+e+"]",this._ts(),this.name];return t&&(n=n.concat(["-",t])),n.join(" ")}},{key:"_log",value:function(t){var n=this.level;e.LOG_LEVEL&&(n=e.LOG_LEVEL),"undefined"!=typeof window&&window.LOG_LEVEL&&(n=window.LOG_LEVEL);var i=LOG_LEVELS[n];if(LOG_LEVELS[t]>=i){var s=console.log;"ERROR"===t&&console.error&&(s=console.error),"WARN"===t&&console.warn&&(s=console.warn);for(var r=arguments.length,o=Array(r>1?r-1:0),a=1;a<r;a++)o[a-1]=arguments[a];if(1===o.length&&"string"==typeof o[0])s(this._key(t,o[0]));else if(1===o.length){var l={};l[this._key(t)]=o[0],s(l)}else if("string"==typeof o[0]){var c=o.slice(1);1===c.length&&(c=c[0]);var u={};u[this._key(t,o[0])]=c,s(u)}else{var h={};h[this._key(t)]=o,s(h)}}}},{key:"log",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this._log.apply(this,["INFO"].concat(t))}},{key:"info",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this._log.apply(this,["INFO"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this._log.apply(this,["WARN"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this._log.apply(this,["ERROR"].concat(t))}},{key:"debug",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this._log.apply(this,["DEBUG"].concat(t))}},{key:"verbose",value:function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];this._log.apply(this,["VERBOSE"].concat(t))}}]),e}(),Logger=ConsoleLogger,Device=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"hasWindow",value:function(){return"undefined"!=typeof window}},{key:"createScript",value:function(e,t,n){var i=document.createElement("script");i.src=e,i.async=!0,i.onload=n,document.body.appendChild(i)}}]),e}(),logger=new Logger("LocalStorage"),defaultOptions={prefix:"_fsts_",expiration:"3600"},LocalStorage=function(){function e(t){babelHelpers.classCallCheck(this,e),logger.debug("creating LocalStorage instance",t),this._options=Object.assign({},defaultOptions,t)}return babelHelpers.createClass(e,[{key:"options",value:function(e){return e&&(this._options=Object.assign({},this._options,e)),this._options}},{key:"key",value:function(e){return this._options.prefix+e}},{key:"set",value:function(e,t){if(e)if(JS.isUndefined(t)||null===t)logger.worn("nothing to set for "+e);else{var n={data:JSON.stringify(t),ts:JS.ts()};this._setItem(e,n)}else logger.warn("no key to set")}},{key:"get",value:function(e){if(e){var t=this._getItem(e);return t?this._isExpired(t)?(logger.verbose("cache miss: "+e),null):(logger.verbose("cache hit: "+e),JSON.parse(t.data)):(logger.verbose("cache miss: "+e),null)}logger.warn("no key to get")}},{key:"remove",value:function(e){e?this._removeItem(e):logger.warn("no key to remove")}},{key:"clear",value:function(){for(var e=window.localStorage;e.length>0;){var t=e.key(0);e.removeItem(t)}}},{key:"purgeExpired",value:function(){for(var e=window.localStorage;e.length>0;){var t=e.key(0),n=JSON.parse(e.getItem(t));this._isExpired(n)&&e.removeItem(t)}}},{key:"_setItem",value:function(e,t){window.localStorage.setItem(this.key(e),JSON.stringify(t))}},{key:"_getItem",value:function(e){var t=window.localStorage.getItem(this.key(e));if(!t)return null;var n=JSON.parse(t);return{data:n.data,ts:1*n.ts}}},{key:"_removeItem",value:function(e){window.localStorge.removeItem(this.key(e))}},{key:"_isExpired",value:function(e){var t=JS.ts();return e.ts+1e3*this._options.expiration<t}}]),e}(),logger$1=new Logger("MemoryStorage"),defaultOptions$1={expiration:"3600"},MemoryStorage=function(){function e(t){babelHelpers.classCallCheck(this,e),logger$1.debug("creating MemoryStorage instance",t),this._options=Object.assign({},defaultOptions$1,t),this._store={}}return babelHelpers.createClass(e,[{key:"options",value:function(e){return e&&(this._options=Object.assign({},this._options,e)),this._options}},{key:"set",value:function(e,t){if(e)if(JS.isUndefined(t)||null===t)logger$1.worn("nothing to set for "+e);else{var n={data:JSON.stringify(t),ts:JS.ts()};this._store[e]=n}else logger$1.warn("no key to set")}},{key:"get",value:function(e){if(e){var t=this._store[e];return t?this._isExpired(t)?(logger$1.verbose("cache miss: "+e),null):(logger$1.verbose("cache hit: "+e),JSON.parse(t.data)):(logger$1.verbose("cache miss: "+e),null)}logger$1.warn("no key to get")}},{key:"remove",value:function(e){e?delete this._store[e]:logger$1.warn("no key to remove")}},{key:"clear",value:function(){this._store={}}},{key:"purgeExpired",value:function(){var e=this;Object.keys(this._store).forEach(function(t){var n=e._store[t];e._isExpired(n)&&delete e._store[t]})}},{key:"_isExpired",value:function(e){var t=JS.ts();return e.ts+1e3*this._options.expiration<t}}]),e}(),_instance=Device.hasWindow()?new LocalStorage:new MemoryStorage,logger$2=new Logger("SSO.Google"),default_options={google_client_id:null,script:"https://apis.google.com/js/platform.js",scope:"profile email openid"},Google=function(){function e(t){babelHelpers.classCallCheck(this,e),"string"==typeof t&&(t={google_client_id:t}),this._options=Object.assign({},default_options,t),this._options.google_client_id||logger$2.warn("missing google_client_id"),this.signIn=this.signIn.bind(this),this.signOut=this.signOut.bind(this),this.check=this.check.bind(this),this.ready=this.ready.bind(this),this._initGapi=this._initGapi.bind(this),this._user=this._user.bind(this),this._ga=null,this._createScript()}return babelHelpers.createClass(e,[{key:"signIn",value:function(){var e=this;return this._ga?this._ga.signIn().then(function(t){return e._user(t)}):Promise.reject("no ga instance")}},{key:"signOut",value:function(){return this._ga?this._ga.signOut():Promise.reject("no ga instance")}},{key:"check",value:function(){var e=this;return this._ga?new Promise(function(t,n){var i=e._ga.currentUser.get();i?i.isSignedIn()?t(e._user(i)):n("not signed in"):n("no google user")}):Promise.reject("no ga instance")}},{key:"ready",value:function(){if(!this._options.google_client_id)return Promise.reject("missing google_client_id in options");var e=this;return new Promise(function(t,n){var i=0;!function s(){i++,e._ga?t():window.gapi?e._initGapi():i<5?window.setTimeout(s,500):n("timeout")}()})}},{key:"_user",value:function(e){var t=e.getAuthResponse().id_token,n=e.getBasicProfile();return{id_token:t,email:n.getEmail(),name:n.getName()}}},{key:"_createScript",value:function(){if(window.gapi)this._initGapi();else{if("none"!==this._options.script){var e=this._options.script;Device.createScript(e,!0,this._initGapi)}}}},{key:"_initGapi",value:function(){logger$2.debug("init gapi");var e=this._options,t=e.google_client_id,n=e.scope;if(t){var i=this,s=window.gapi;s.load("auth2",function(){s.auth2.init({client_id:t,scope:n}).then(function(e){i._ga=e})})}else logger$2.warn("missing google_client_id in options")}}]),e}(),logger$3=new Logger("SSO.Facebook"),default_options$1={facebook_app_id:null,script:"https://connect.facebook.net/en_US/sdk.js",scope:"public_profile,email"},Facebook=function(){function e(t){babelHelpers.classCallCheck(this,e),"string"==typeof t&&(t={facebook_app_id:t}),this._options=Object.assign({},default_options$1,t),this._options.facebook_app_id||logger$3.warn("missing facebook_app_id"),this.signIn=this.signIn.bind(this),this.signOut=this.signOut.bind(this),this.check=this.check.bind(this),this.ready=this.ready.bind(this),this._fbAsyncInit=this._fbAsyncInit.bind(this),this._user=this._user.bind(this),this._fb=null,this._createScript()}return babelHelpers.createClass(e,[{key:"signIn",value:function(){var e=this,t=this._fb;if(!t)return Promise.reject("no fb instance");var n=this._options.scope;return this.check().then(function(t){return e._user(t)}).catch(function(i){return new Promise(function(i,s){t.login(function(t){i(e._user(t.authResponse))},{scope:n})})})}},{key:"signOut",value:function(){var e=this._fb;return e?new Promise(function(t,n){e.logout(function(e){logger$3.debug("signed out",e),t()})}):Promise.reject("no fb instance")}},{key:"check",value:function(){var e=this._fb;return e?new Promise(function(t,n){e.getLoginStatus(function(e){"connected"===e.status?t(e.authResponse):n(e)})}):Promise.reject("no fb instance")}},{key:"ready",value:function(){if(!this._options.facebook_app_id)return Promise.reject("missing facebook_app_id in props");var e=this;return new Promise(function(t,n){var i=0;!function s(){i++;{if(!e._fb)return window.FB?(e._fb=window.FB,void t()):void(i<5?window.setTimeout(s,500):n("timeout"));t()}}()})}},{key:"_user",value:function(e){if(!e)return Promise.reject("no authResponse");var t=e.accessToken,n=e.userID;if(!t)return Promise.reject("no accessToken");var i=this._fb;return new Promise(function(e,s){i.api("/me",function(i){var s={accessToken:t,userID:n,name:i.name};logger$3.debug("user",s),e(s)})})}},{key:"_fbAsyncInit",value:function(){logger$3.debug("init FB");var e=this._options.facebook_app_id;if(e){var t=window.FB;t.init({appId:e,cookie:!0,xfbml:!0,version:"v2.11"}),this._fb=t}else logger$3.warn("missing facebook_app_id in props")}},{key:"_createScript",value:function(){if(window.FB)this._fbAsyncInit();else{"none"!==this._options.script?(window.fbAsyncInit=this._fbAsyncInit,Device.createScript(this._options.script,!0)):window.FB&&(this._fb=window.FB)}}}]),e}(),logger$4=new Logger("SSO.LinkedIn"),default_options$2={api_key:null,script:"http://platform.linkedin.com/in.js?async=true"},LinkedIn=function(){function e(t){babelHelpers.classCallCheck(this,e),"string"==typeof t&&(t={api_key:t}),this._options=Object.assign({},default_options$2,t),this._options.api_key||logger$4.warn("missing api_key"),this.signIn=this.signIn.bind(this),this.signOut=this.signOut.bind(this),this.check=this.check.bind(this),this.ready=this.ready.bind(this),this._user=this._user.bind(this),this._initIn=this._initIn.bind(this),this._fullyLoaded=this._fullyLoaded.bind(this),this._IN=null,this._INLoaded=!1,this._createScript()}return babelHelpers.createClass(e,[{key:"signIn",value:function(){var e=this._IN;if(!e)return Promise.reject("no IN instance");var t=this;return new Promise(function(n,i){e.User.authorize(function(){t._user().then(function(e){return n(e)}).catch(function(e){return i(e)})})})}},{key:"signOut",value:function(){var e=this._IN;return e?new Promise(function(t,n){e.User.logout(function(){logger$4.debug("signed out"),t()})}):Promise.reject("no IN instance")}},{key:"check",value:function(){var e=this._IN;return e?e.User.isAuthorized()?this._user():Promise.reject("not authorized"):Promise.reject("no IN instance")}},{key:"ready",value:function(){if(!this._options.api_key)return Promise.reject("missing api_key");var e=this;return new Promise(function(t,n){var i=0;!function s(){i++,e._IN&&e._INLoaded?t():window.IN?e._initIn():i<5?window.setTimeout(s,500):n("timeout")}()})}},{key:"_user",value:function(){var e=this._IN;return new Promise(function(t,n){e.API.Raw("/people/~").result(function(e){var n=e.firstName,i=e.lastName,s=e.id,r=e.headline;t({id:s,firstName:n,lastName:i,headline:r})}).error(function(e){return n(e)})})}},{key:"_createScript",value:function(){window.IN&&this._initIn();"none"!==this._options.script&&(window._in_onload=this._fullyLoaded,Device.createScript(this._options.script,!0,this._initIn))}},{key:"_initIn",value:function(){logger$4.debug("init IN");var e=this._options.api_key;if(e){var t=window.IN;t.init({api_key:e,authorize:!0,onLoad:"_in_onload"}),this._IN=t}else logger$4.warn("missing api_key")}},{key:"_fullyLoaded",value:function(){logger$4.debug("fully loaded"),this._INLoaded=!0}}]),e}(),SSO={Google:Google,Facebook:Facebook,LinkedIn:LinkedIn},logger$7=new Logger("Subscriber"),Subscriber=function(){function e(t,n){babelHelpers.classCallCheck(this,e),this.channel=t,this.noticeHandler=n,this.cursor=-1}return babelHelpers.createClass(e,[{key:"notify",value:function(){var e=this.channel.poll(this.cursor);if(this.cursor=channel.cursor,e.length>0)for(var t=0;t<e.length;t++)this._notifyEvent(e[t])}},{key:"_notifyEvent",value:function(){var e=babelHelpers.asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{this.noticeHandler(t)}catch(e){logger$7.error("notify event error",e,t,this.noticeHandler)}case 1:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()}]),e}(),logger$6=new Logger("Channel"),default_options$4={bufferSize:128},Channel=function(){function e(t,n){babelHelpers.classCallCheck(this,e),this.name=t,this.events=[],this.subscribers=[],this.cursor=-1,this._options=Object.assign({},default_options$4,n)}return babelHelpers.createClass(e,[{key:"subscribe",value:function(e){if(this.subscribers.filter(function(t){return t.noticeHandler===e}).length>0)logger$6.debug("duplicated subscription on channel "+this.name,e);else{var t=new Subscriber(this,e);this.subscribers.push(t),t.notify()}}},{key:"unsubscribe",value:function(e){this.subscribers=this.subscribers.filter(function(t){return t.noticeHandler!==e})}},{key:"send",value:function(e){e||logger$6.warn("nothing to send to channel "+this.name);var t=this._options.bufferSize;this.cursor++;var n=this.cursor%t;n<this.events.length?this.events[n]=e:this.events.push(e),this.subscribers.forEach(function(e){return e.notify()})}},{key:"poll",value:function(e){if(JS.isUndefined(lastCursor)&&(e=-1),e===this.cursor)return[];for(var t=[],n=this._options.bufferSize,i=e+1;i<=this.cursor;i++){var s=i%n;if(s>=this.events.length){logger$6.error("idx overflow");break}t.push(this.events[s])}return t}}]),e}(),logger$5=new Logger("Pipe"),default_options$3={bufferSize:128},CHANNEL_BROADCAST="_broadcast_",Pipe=function(){function e(t,n){babelHelpers.classCallCheck(this,e),this.name=t,this._options=Object.assign({},default_options$3,n),this._channels={}}return babelHelpers.createClass(e,[{key:"send",value:function(e,t){t||(t=e.channel),t||(t=CHANNEL_BROADCAST);this._getChannel(t).send(e)}},{key:"subscribe",value:function(e,t){t||(t=CHANNEL_BROADCAST);this._getChannel(t).subscribe(e)}},{key:"_getChannel",value:function(e){if(!e)return null;var t=this._channels[e];return t||(t=new Channel(e),this.channels[e]=t),t}}]),e}(),pipe=new Pipe("_root_"),Url=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"params",value:function(e){var t=e.split("?");if(t.length<2)return{};var n={};return(t=t[1].split("#")[0].split("&")).forEach(function(e){var t=e.split("="),i=t[0],s=t.length>1?t.slice(1).join(""):"";n[i]=decodeURIComponent(s)}),n}}]),e}();exports.Logger=Logger,exports.Cache=_instance,exports.SSO=SSO,exports.Pipe=Pipe,exports.pipe=pipe,exports.Device=Device,exports.JS=JS,exports.Url=Url;
//# sourceMappingURL=fsts.min.js.map
